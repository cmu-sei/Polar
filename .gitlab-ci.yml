stages:
- build
- charts

default:
  tags:
    - kubernetes

build-enviornments:
  image: registry.sandbox.labz.s-box.org/vcaaron/flaskr/nix:2.24.9
  stage: build
  variables:
    VERSION: "0.1.0"
    REGISTRY: registry.sandbox.labz.s-box.org/SEI/polar-mirror
    IMAGE_NAME: $CI_PROJECT_NAME
    
  script:
      #install needed tools
    - nix-env --install --attr nixpkgs.skopeo
    - |
      echo "Configuring nix and the filesystem"
      mkdir -p "$HOME/.config/nix"
      mkdir -p "/etc/containers/"
      #setup nixconfig
      printf 'experimental-features = nix-command flakes' > "$HOME/.config/nix/nix.conf"
      echo '{"default":[{"type":"insecureAcceptAnything"}]}' > /etc/containers/policy.json
      git config --global --add safe.directory "$(pwd)"
    - cd dev-container

    # build workspace
    - 'nix build --eval-system x86_64-linux --show-trace .#devContainer -o polar-dev'
    - 'nix build --eval-system x86_64-linux --show-trace .#ciContainer -o polar-ci'
    
    #  Use skopeo to inspect and upload our images
    - skopeo login --username "$CI_REGISTRY_USER" --password "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - 'skopeo inspect docker-archive://$(readlink -f ./polar-dev)'
    - 'skopeo copy docker-archive://$(readlink -f ./polar-dev) docker://$REGISTRY/polar-dev:0.1.0'
    - 'skopeo inspect docker-archive://$(readlink -f ./polar-ci)'
    - 'skopeo copy docker-archive://$(readlink -f ./polar-ci) docker://$REGISTRY/polar-ci:0.1.0'


build-workspace:
  image: registry.sandbox.labz.s-box.org/SEI/polar-mirror/polar-ci:0.1.0
  stage: build
  variables:
    REGISTRY: registry.sandbox.labz.s-box.org/SEI/polar-mirror
  script:
    - |
      echo "Configuring nix and the filesystem"
      mkdir -p "$HOME/.config/nix"
      mkdir -p "/etc/containers/"
      #setup nixconfig
      printf 'experimental-features = nix-command flakes' > "$HOME/.config/nix/nix.conf"
      echo '{"default":[{"type":"insecureAcceptAnything"}]}' > /etc/containers/policy.json
      git config --global --add safe.directory "$(pwd)"
    - cd src/agents/

    # TODO: run nix flake checks to run unit testing and other static analysis
    # build workspace
    - 'nix build --eval-system x86_64-linux --show-trace .#default'

    # using already built dependencies, package and containerize our components.
    - 'nix build --eval-system x86_64-linux --show-trace .#cassiniImage -o caassini'
    - 'nix build --eval-system x86_64-linux --show-trace .#observerImage -o observer'
    - 'nix build --eval-system x86_64-linux --show-trace .#consumerImage -o consumer'
    
    # Vulnerability analysis on our store
    # TODO: Move this to another job?
    - vulnix --system --json > vulnix-results.json

    # Use skopeo to inspect and upload our images
    - skopeo login --username "$CI_REGISTRY_USER" --password "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - ls -lh
    - | 
      'skopeo inspect docker-archive://$(readlink -f ./cassini)'
      'skopeo copy docker-archive://$(readlink -f ./cassini) docker://$REGISTRY/cassini:latest'
      'skopeo inspect docker-archive://$(readlink -f ./observer)'
      'skopeo copy docker-archive://$(readlink -f ./observer) docker://$REGISTRY/polar-gitlab-observer:0.1.0'
      'skopeo inspect docker-archive://$(readlink -f ./consumer)'
      'skopeo copy docker-archive://$(readlink -f ./consumer) docker://$REGISTRY/polar-gitlab-consumer:0.1.0'
  artifacts:
    paths:
      - src/agents/vulnix-results.json

make-charts:
  image: registry.sandbox.labz.s-box.org/SEI/polar-mirror/polar-ci:0.1.0
  stage: charts
  variables:
    REGISTRY: registry.sandbox.labz.s-box.org/SEI/polar-mirror
  script:
  #TODO: Generate helm charts and push them to a hosted repository
    - cd src/deploy/ 
    - chmod +x ./make-chart.sh
    - sh ./make-chart.sh cassini polar-cassini
    - sh ./make-chart.sh neo4j polar-neo4j
    - sh ./make-chart.sh gitlab polar-gitlab-agent
